const json = {"12/06/22": {"gh": 2}, "04/09/22": {"gh": 2}, "23/10/22": {"gh": 2}, "06/06/22": {"gh": 3}, "07/11/22": {"gh": 1}, "07/06/22": {"gh": 3}, "08/06/22": {"gh": 1}, "31/08/22": {"cf": 2}, "26/10/22": {"gh": 2}, "09/06/22": {"gh": 1}, "16/06/22": {"gh": 1}, "08/09/22": {"gh": 1}, "10/11/22": {"gh": 3}, "10/06/22": {"gh": 1}, "02/09/22": {"gh": 1}, "09/09/22": {"cf": 3}, "09/04/22": {"gh": 1}, "22/10/22": {"cses": 2}, "12/11/22": {"gh": 3}, "12/03/23": {"gh": 5}, "09/04/23": {"gh": 1}, "16/07/23": {"cses": 5}, "06/08/23": {"gh": 3}, "13/08/23": {"gh": 2}, "24/09/23": {"gh": 9}, "10/12/23": {"gh": 1}, "27/02/23": {"gh": 1}, "13/03/23": {"gh": 1}, "17/04/23": {"cses": 2}, "07/08/23": {"gh": 1}, "04/09/23": {"gh": 1}, "11/09/23": {"gh": 1}, "25/09/23": {"gh": 1}, "11/12/23": {"cf": 4}, "01/08/23": {"gh": 3}, "05/09/23": {"gh": 10}, "12/09/23": {"gh": 5}, "19/09/23": {"gh": 1}, "26/09/23": {"gh": 9}, "01/03/23": {"gh": 9}, "26/07/23": {"gh": 2}, "06/09/23": {"gh": 3}, "20/09/23": {"gh": 3}, "27/09/23": {"gh": 6}, "13/12/23": {"gh": 1}, "02/02/23": {"gh": 2}, "02/03/23": {"gh": 2}, "24/08/23": {"cf": 3}, "21/09/23": {"gh": 5}, "07/12/23": {"gh": 7}, "14/12/23": {"gh": 2}, "03/02/23": {"cf": 12}, "03/03/23": {"gh": 2}, "04/08/23": {"cf": 2}, "22/09/23": {"gh": 6}, "08/12/23": {"gh": 2}, "15/12/23": {"gh": 3}, "04/02/23": {"gh": 1}, "05/08/23": {"cf": 25}, "23/09/23": {"gh": 6}, "18/02/24": {"cf": 7}, "03/03/24": {"gh": 2}, "26/05/24": {"gh": 5}, "23/06/24": {"gh": 3}, "07/07/24": {"gh": 4}, "13/10/24": {"gh": 1}, "04/03/24": {"gh": 2}, "15/04/24": {"gh": 1}, "24/06/24": {"gh": 1}, "02/12/24": {"gh": 3}, "02/01/24": {"cf": 8}, "09/01/24": {"gh": 1}, "20/02/24": {"cf": 1}, "09/04/24": {"gh": 7}, "16/04/24": {"gh": 2}, "30/04/24": {"gh": 1}, "02/07/24": {"gh": 1}, "08/10/24": {"gh": 1}, "22/10/24": {"gh": 2}, "10/01/24": {"gh": 1}, "10/04/24": {"gh": 1}, "17/04/24": {"gh": 7}, "16/10/24": {"gh": 1}, "23/10/24": {"gh": 1}, "04/12/24": {"gh": 3}, "18/12/24": {"gh": 3}, "29/02/24": {"cf": 3}, "11/04/24": {"gh": 3}, "13/06/24": {"gh": 4}, "12/12/24": {"gh": 2}, "12/01/24": {"gh": 2}, "01/03/24": {"gh": 1}, "12/04/24": {"gh": 14}, "28/06/24": {"gh": 1}, "13/12/24": {"gh": 1}, "17/02/24": {"gh": 3}, "02/03/24": {"gh": 2}, "28/09/24": {"gh": 1}, "07/12/24": {"gh": 4}, "14/01/25": {"gh": 1}, "11/02/25": {"gh": 2}, "12/02/25": {"gh": 2}, "09/01/25": {"gh": 2}, "13/02/25": {"gh": 2}, "10/01/25": {"gh": 3}, "17/01/25": {"gh": 1}, "08/02/25": {"gh": 5}, "14/09/23": {"bc": 1}, "24/11/22": {"bc": 1}, "25/10/22": {"bc": 1}, "07/10/22": {"bc": 1}, "06/10/22": {"bc": 2}, "30/09/22": {"bc": 1}, "29/09/22": {"bc": 1}, "26/09/22": {"cf": 1}, "16/09/22": {"bc": 1}, "05/09/22": {"bc": 2}, "03/09/22": {"bc": 1}, "29/08/22": {"bc": 3}, "28/08/22": {"bc": 1}, "22/08/22": {"bc": 2}, "17/08/22": {"bc": 1}, "16/08/22": {"bc": 3}, "08/08/22": {"bc": 1}, "05/08/22": {"bc": 1}, "01/08/22": {"bc": 3}, "30/07/22": {"bc": 1}, "29/07/22": {"bc": 1}, "10/07/22": {"bc": 1}, "08/07/22": {"bc": 1}, "06/07/22": {"bc": 1}, "03/07/22": {"bc": 1}, "01/07/22": {"bc": 1}, "30/06/22": {"bc": 1}, "28/06/22": {"bc": 1}, "26/06/22": {"bc": 5}, "25/06/22": {"bc": 1}, "28/03/24": {"cf": 5}, "12/03/24": {"cf": 6}, "28/02/24": {"cf": 15}, "27/02/24": {"cf": 5}, "24/02/24": {"cf": 5}, "23/02/24": {"cf": 15}, "21/02/24": {"cf": 3}, "19/02/24": {"cf": 6}, "16/02/24": {"cf": 4}, "15/02/24": {"cf": 4}, "13/02/24": {"cf": 4}, "30/01/24": {"cf": 7}, "28/01/24": {"cf": 9}, "26/01/24": {"cf": 13}, "25/01/24": {"cf": 12}, "24/01/24": {"cf": 10}, "23/01/24": {"cf": 16}, "22/01/24": {"cf": 5}, "21/01/24": {"cf": 4}, "20/01/24": {"cf": 2}, "18/01/24": {"cf": 4}, "17/01/24": {"cf": 9}, "16/01/24": {"cses": 2}, "15/01/24": {"cf": 14}, "14/01/24": {"cf": 14}, "13/01/24": {"cf": 8}, "06/01/24": {"cf": 3}, "05/01/24": {"cf": 2}, "05/12/23": {"cf": 7}, "04/12/23": {"cf": 5}, "03/12/23": {"cf": 1}, "02/12/23": {"cf": 15}, "01/12/23": {"cf": 4}, "30/11/23": {"cf": 3}, "28/11/23": {"cf": 4}, "26/11/23": {"cf": 12}, "25/11/23": {"cf": 8}, "24/11/23": {"cf": 5}, "23/11/23": {"cf": 2}, "19/11/23": {"cf": 4}, "13/11/23": {"cf": 1}, "01/11/23": {"cf": 1}, "29/10/23": {"cf": 7}, "28/10/23": {"cf": 5}, "27/10/23": {"cf": 1}, "31/08/23": {"cf": 5}, "02/08/23": {"cf": 14}, "24/07/23": {"cf": 8}, "23/07/23": {"cf": 23}, "22/07/23": {"cf": 15}, "18/07/23": {"cf": 23}, "15/07/23": {"cf": 17}, "11/07/23": {"cf": 4}, "10/07/23": {"cses": 3}, "09/07/23": {"cf": 9}, "08/07/23": {"cses": 7}, "07/07/23": {"cf": 10}, "04/07/23": {"cf": 1}, "01/07/23": {"cf": 8}, "30/06/23": {"cf": 1}, "01/02/23": {"cf": 1}, "27/01/23": {"cf": 6}, "12/12/22": {"cf": 1}, "05/12/22": {"cf": 1}, "04/12/22": {"cf": 5}, "29/11/22": {"cf": 1}, "27/10/22": {"cf": 4}, "10/10/22": {"cf": 7}, "04/10/22": {"cf": 2}, "23/09/22": {"cf": 3}, "22/09/22": {"cf": 3}, "21/09/22": {"cf": 5}, "17/09/22": {"cf": 12}, "13/09/22": {"cf": 1}, "12/09/22": {"cf": 4}, "10/09/22": {"cf": 4}, "01/09/22": {"cf": 2}, "16/10/22": {"cses": 6}, "12/10/22": {"cses": 3}, "19/10/22": {"cses": 11}, "04/07/24": {"cses": 10}, "05/07/24": {"cses": 2}, "17/10/22": {"cses": 10}, "28/10/22": {"cses": 8}, "29/10/22": {"cses": 2}, "28/11/22": {"cses": 2}, "27/11/22": {"cses": 2}, "01/11/22": {"cses": 1}, "30/10/22": {"cses": 5}, "06/07/23": {"cses": 2}, "27/07/23": {"cses": 4}, "25/07/23": {"cses": 4}}
const last_update = "15/02/25";

const formatter = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
const msInADay = 86400000;
const numCols = 54;
const numLins = 8;
const firstLin = 1;
const firstCol = 1;

const codeforcesColor = 'mediumBlue';
const githubColor = 'green';
const beecrowdColor = 'purple';
const csesColor = 'brown';
const inactiveColor = 'dimgray';

let currentSelectedYear = 0;

window.onload = function () {
    addYearOptions();
    addJsonInfoToCalendar();
    addClickListener();
    addLastTimeUpdated();
}

function addYearOptions() {
    document.getElementById('year-filter-container').innerHTML +=
        `<div class="filter sm-display-block">
            <input id="year0" type="checkbox" checked onclick="addJsonInfoToCalendar(0)">
            <label for="year0">Now</label>
        </div>`;

    const yearNow = new Date().getFullYear();
    const yearDiff = yearNow - 2022;
    for (let i = 1; i <= yearDiff; i++) {
        const id = 'year' + i;
        document.getElementById('year-filter-container').innerHTML +=
            `<div class="filter sm-display-block">
                <input id="${id}" type="checkbox" onclick="addJsonInfoToCalendar(${i})">
                <label for="${id}">${i} year ago</label>
            </div>`;
    }
}

function addJsonInfoToCalendar(yearDiff) {
    if (yearDiff === undefined) yearDiff = currentSelectedYear;
    currentSelectedYear = yearDiff;
    updateYearCheckboxes(yearDiff);
    
    let table = document.getElementById("calendar");
    resetMonthsNames(table);

    let currDate = new Date();
    currDate.setTime(currDate.getTime() - (yearDiff * msInADay * 365));
    let dayOfWeek = currDate.getDay();

    hideExtraDaySquares(table, dayOfWeek);
    highlightRightMostSquare(table, table.rows[firstLin+dayOfWeek].cells[numCols-1]);
    setToolTips(table, currDate, dayOfWeek);
}

function setToolTips(table, currDate, dayOfWeek) {
    for (let i = firstLin+dayOfWeek; i >= firstLin; i--) {
        setDayActivity(table.rows[i].cells[numCols-1], currDate);
        writeMonthName(currDate, table.rows[0].cells[numCols-1]);
        currDate.setTime(currDate.getTime() - msInADay);
    }

    for (let j = numCols-2; j >= firstCol; j--) {
        for (let i = numLins-1; i >= firstLin; i--) {
            setDayActivity(table.rows[i].cells[j], currDate);
            writeMonthName(currDate, table.rows[0].cells[j]);

            currDate.setTime(currDate.getTime() - msInADay);
        }
    }
}

function highlightRightMostSquare(table, cell) {
    for (let i = firstLin; i < numLins; i++) {
        table.rows[i].cells[numCols-1].style.borderWidth = '0';
    }
    cell.style.border = 'solid';
    cell.style.borderColor = 'yellow';
    cell.style.borderWidth = '1px';
}

function updateYearCheckboxes(selectedYear) {
    const yearNow = new Date().getFullYear();
    const yearDiff = yearNow - 2022;
    for (let i = 0; i <= yearDiff; i++) {
        document.getElementById('year' + i).checked = false;
    }
    document.getElementById('year' + selectedYear).checked = true;
}

function writeMonthName(date, cell) {
    if (date.getDate() != 1) return;

    cell.innerHTML = date.toLocaleString('en-US', { month: 'long' }).substring(0, 3);
    cell.style.visibility = 'visible';
    cell.style.background = 'rgba(0,0,0,0)';
}

function hideExtraDaySquares(table, dayOfWeek) {
    for (let i = firstLin; i < numLins; i++) {
        table.rows[i].cells[firstLin].style.visibility = 'visible';
        table.rows[i].cells[numCols-1].style.visibility = 'visible';
    }
    for (let i = firstLin; i < dayOfWeek+firstLin; i++) { table.rows[i].cells[firstLin].style.visibility = 'hidden'; }
    for (let i = firstLin+dayOfWeek+1; i < numLins; i++) { table.rows[i].cells[numCols-1].style.visibility = 'hidden'; }
}

function resetMonthsNames(table) {
    for (let i=0; i < numCols; i++) {
        table.rows[0].cells[i].innerHTML = '';
    }
}

function setDayActivity(cell, date) {
    let dateStr = formatter.format(date);
    
    if (!json.hasOwnProperty(dateStr)) {
        cell.getElementsByTagName('span')[0].innerHTML = 'no activity on ' + dateStr;
        cell.style.backgroundColor = inactiveColor;
        return;
    }
    const cf = json[dateStr]["cf"] == undefined ? 0 : json[dateStr]["cf"];
    const gh = json[dateStr]["gh"] == undefined ? 0 : json[dateStr]["gh"];
    const bc = json[dateStr]["bc"] == undefined ? 0 : json[dateStr]["bc"];
    const cses = json[dateStr]["cses"] == undefined ? 0 : json[dateStr]["cses"];
    let cf_checked = document.getElementById('cf-checkbox').checked;
    let gh_checked = document.getElementById('gh-checkbox').checked;
    let bc_checked = document.getElementById('bc-checkbox').checked;
    let cses_checked = document.getElementById('cses-checkbox').checked;

    const max = Math.max(cf, gh, bc, cses);

    if (cf_checked && cf == max) { cell.style.backgroundColor = codeforcesColor; }
    else if (gh_checked && gh == max) { cell.style.backgroundColor = githubColor; }
    else if (bc_checked && bc == max) { cell.style.backgroundColor = beecrowdColor; }
    else if (cses_checked && cses == max) { cell.style.backgroundColor = csesColor; }
    else { cell.style.backgroundColor = inactiveColor; }

    let activities = 0;
    if (cf_checked) activities += cf;
    if (gh_checked) activities += gh;
    if (bc_checked) activities += bc;
    if (cses_checked) activities += cses;
    cell.getElementsByTagName('span')[0].innerHTML = activities + ' activities on ' + dateStr;
}

function addClickListener() {
    const tbody = document.querySelector('#calendar tbody');
    tbody.addEventListener('click', function (e) {
        const cell = e.target.closest('td');
        if (!cell) return;
        
        let dateStr = cell.getElementsByTagName('span')[0].innerHTML.split(' ').pop();
        let title = document.getElementById('detail-title');
        title.innerHTML = 'Showing details for ' + dateStr;

        let cf = 0;
        let gh = 0;
        let bc = 0;
        let cses = 0;
        if (json.hasOwnProperty(dateStr)) {
            if (json[dateStr].hasOwnProperty("cf")) cf = json[dateStr]["cf"];
            if (json[dateStr].hasOwnProperty("gh")) gh = json[dateStr]["gh"];
            if (json[dateStr].hasOwnProperty("bc")) bc = json[dateStr]["bc"];
            if (json[dateStr].hasOwnProperty("cses")) cses = json[dateStr]["cses"];
        }
        document.getElementById('codeforces-detail').innerHTML = cf == 0 ? "" : "codeforces: " + cf + " submissions";
        document.getElementById('github-detail').innerHTML = gh == 0 ? "" : "github: " + gh + " commits";
        document.getElementById('beecrowd-detail').innerHTML = bc == 0 ? "" : "beecrowd: " + bc + " solves";
        document.getElementById('cses-detail').innerHTML = cses == 0 ? "" : "cses: " + cses + " submissions";
        document.getElementById('day-details').className = 'highlight';
        setTimeout(() => {
            document.getElementById('day-details').className = '';
        }, 300);
    });
}

function addLastTimeUpdated() {
    document.getElementById('last-update').innerHTML = `
    <p>Last time updated: ${last_update}</p>
    `
}