const json = {"28/03/24": {"cf": 5, "gh": 0}, "12/03/24": {"cf": 6, "gh": 0}, "29/02/24": {"cf": 3, "gh": 2}, "28/02/24": {"cf": 15, "gh": 0}, "27/02/24": {"cf": 5, "gh": 0}, "24/02/24": {"cf": 5, "gh": 0}, "23/02/24": {"cf": 15, "gh": 0}, "21/02/24": {"cf": 3, "gh": 0}, "20/02/24": {"cf": 1, "gh": 8}, "19/02/24": {"cf": 6, "gh": 0}, "18/02/24": {"cf": 7, "gh": 2}, "16/02/24": {"cf": 4, "gh": 0}, "15/02/24": {"cf": 4, "gh": 0}, "13/02/24": {"cf": 4, "gh": 0}, "30/01/24": {"cf": 7, "gh": 0}, "28/01/24": {"cf": 9, "gh": 0}, "26/01/24": {"cf": 13, "gh": 0}, "25/01/24": {"cf": 12, "gh": 0}, "24/01/24": {"cf": 10, "gh": 0}, "23/01/24": {"cf": 16, "gh": 0}, "22/01/24": {"cf": 5, "gh": 0}, "21/01/24": {"cf": 4, "gh": 0}, "20/01/24": {"cf": 2, "gh": 0}, "18/01/24": {"cf": 4, "gh": 0}, "17/01/24": {"cf": 9, "gh": 0}, "16/01/24": {"cf": 15, "gh": 0}, "15/01/24": {"cf": 14, "gh": 0}, "14/01/24": {"cf": 14, "gh": 0}, "13/01/24": {"cf": 8, "gh": 0}, "06/01/24": {"cf": 3, "gh": 0}, "05/01/24": {"cf": 2, "gh": 0}, "02/01/24": {"cf": 8, "gh": 1}, "11/12/23": {"cf": 4, "gh": 1}, "05/12/23": {"cf": 7, "gh": 0}, "04/12/23": {"cf": 5, "gh": 0}, "03/12/23": {"cf": 1, "gh": 0}, "02/12/23": {"cf": 15, "gh": 0}, "01/12/23": {"cf": 4, "gh": 0}, "30/11/23": {"cf": 3, "gh": 0}, "28/11/23": {"cf": 4, "gh": 0}, "26/11/23": {"cf": 12, "gh": 0}, "25/11/23": {"cf": 8, "gh": 0}, "24/11/23": {"cf": 5, "gh": 0}, "23/11/23": {"cf": 2, "gh": 0}, "19/11/23": {"cf": 4, "gh": 0}, "13/11/23": {"cf": 1, "gh": 0}, "01/11/23": {"cf": 1, "gh": 0}, "29/10/23": {"cf": 7, "gh": 0}, "28/10/23": {"cf": 5, "gh": 0}, "27/10/23": {"cf": 1, "gh": 0}, "31/08/23": {"cf": 5, "gh": 0}, "24/08/23": {"cf": 3, "gh": 2}, "05/08/23": {"cf": 25, "gh": 3}, "04/08/23": {"cf": 2, "gh": 1}, "02/08/23": {"cf": 14, "gh": 0}, "24/07/23": {"cf": 8, "gh": 0}, "23/07/23": {"cf": 23, "gh": 0}, "22/07/23": {"cf": 15, "gh": 0}, "18/07/23": {"cf": 23, "gh": 0}, "15/07/23": {"cf": 17, "gh": 0}, "11/07/23": {"cf": 4, "gh": 0}, "10/07/23": {"cf": 4, "gh": 0}, "09/07/23": {"cf": 9, "gh": 0}, "08/07/23": {"cf": 7, "gh": 0}, "07/07/23": {"cf": 10, "gh": 0}, "04/07/23": {"cf": 1, "gh": 0}, "01/07/23": {"cf": 8, "gh": 0}, "30/06/23": {"cf": 1, "gh": 0}, "03/02/23": {"cf": 12, "gh": 2}, "01/02/23": {"cf": 1, "gh": 0}, "27/01/23": {"cf": 6, "gh": 0}, "12/12/22": {"cf": 1, "gh": 0}, "05/12/22": {"cf": 1, "gh": 0}, "04/12/22": {"cf": 5, "gh": 0}, "29/11/22": {"cf": 1, "gh": 0}, "27/10/22": {"cf": 4, "gh": 0}, "10/10/22": {"cf": 7, "gh": 0}, "04/10/22": {"cf": 2, "gh": 0}, "26/09/22": {"cf": 1, "gh": 0}, "23/09/22": {"cf": 3, "gh": 0}, "22/09/22": {"cf": 3, "gh": 0}, "21/09/22": {"cf": 5, "gh": 0}, "17/09/22": {"cf": 12, "gh": 0}, "13/09/22": {"cf": 1, "gh": 0}, "12/09/22": {"cf": 4, "gh": 0}, "10/09/22": {"cf": 4, "gh": 0}, "09/09/22": {"cf": 3, "gh": 1}, "01/09/22": {"cf": 2, "gh": 0}, "31/08/22": {"cf": 2, "gh": 2}, "12/06/22": {"cf": 0, "gh": 2}, "04/09/22": {"cf": 0, "gh": 2}, "23/10/22": {"cf": 0, "gh": 2}, "06/06/22": {"cf": 0, "gh": 3}, "07/11/22": {"cf": 0, "gh": 1}, "07/06/22": {"cf": 0, "gh": 3}, "08/06/22": {"cf": 0, "gh": 1}, "26/10/22": {"cf": 0, "gh": 2}, "09/06/22": {"cf": 0, "gh": 1}, "16/06/22": {"cf": 0, "gh": 1}, "08/09/22": {"cf": 0, "gh": 1}, "10/11/22": {"cf": 0, "gh": 3}, "10/06/22": {"cf": 0, "gh": 1}, "02/09/22": {"cf": 0, "gh": 1}, "09/04/22": {"cf": 0, "gh": 1}, "22/10/22": {"cf": 0, "gh": 3}, "12/11/22": {"cf": 0, "gh": 3}, "12/03/23": {"cf": 0, "gh": 5}, "09/04/23": {"cf": 0, "gh": 1}, "16/07/23": {"cf": 0, "gh": 1}, "06/08/23": {"cf": 0, "gh": 3}, "13/08/23": {"cf": 0, "gh": 2}, "24/09/23": {"cf": 0, "gh": 9}, "10/12/23": {"cf": 0, "gh": 1}, "27/02/23": {"cf": 0, "gh": 1}, "13/03/23": {"cf": 0, "gh": 1}, "17/04/23": {"cf": 0, "gh": 3}, "07/08/23": {"cf": 0, "gh": 1}, "04/09/23": {"cf": 0, "gh": 1}, "11/09/23": {"cf": 0, "gh": 1}, "25/09/23": {"cf": 0, "gh": 1}, "01/08/23": {"cf": 0, "gh": 3}, "05/09/23": {"cf": 0, "gh": 10}, "12/09/23": {"cf": 0, "gh": 5}, "19/09/23": {"cf": 0, "gh": 1}, "26/09/23": {"cf": 0, "gh": 9}, "01/03/23": {"cf": 0, "gh": 9}, "26/07/23": {"cf": 0, "gh": 2}, "06/09/23": {"cf": 0, "gh": 3}, "20/09/23": {"cf": 0, "gh": 3}, "27/09/23": {"cf": 0, "gh": 6}, "13/12/23": {"cf": 0, "gh": 1}, "02/02/23": {"cf": 0, "gh": 2}, "02/03/23": {"cf": 0, "gh": 2}, "21/09/23": {"cf": 0, "gh": 5}, "07/12/23": {"cf": 0, "gh": 7}, "14/12/23": {"cf": 0, "gh": 2}, "03/03/23": {"cf": 0, "gh": 2}, "22/09/23": {"cf": 0, "gh": 6}, "08/12/23": {"cf": 0, "gh": 2}, "15/12/23": {"cf": 0, "gh": 3}, "04/02/23": {"cf": 0, "gh": 1}, "23/09/23": {"cf": 0, "gh": 6}, "03/03/24": {"cf": 0, "gh": 2}, "26/05/24": {"cf": 0, "gh": 3}, "04/03/24": {"cf": 0, "gh": 2}, "15/04/24": {"cf": 0, "gh": 1}, "09/01/24": {"cf": 0, "gh": 1}, "09/04/24": {"cf": 0, "gh": 7}, "16/04/24": {"cf": 0, "gh": 2}, "30/04/24": {"cf": 0, "gh": 1}, "10/01/24": {"cf": 0, "gh": 1}, "10/04/24": {"cf": 0, "gh": 1}, "17/04/24": {"cf": 0, "gh": 7}, "11/04/24": {"cf": 0, "gh": 3}, "12/01/24": {"cf": 0, "gh": 2}, "01/03/24": {"cf": 0, "gh": 1}, "12/04/24": {"cf": 0, "gh": 14}, "17/02/24": {"cf": 0, "gh": 3}, "02/03/24": {"cf": 0, "gh": 2}}
const last_update = "26/05/24";

const formatter = new Intl.DateTimeFormat('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
const msInADay = 86400000;
const numCols = 54;
const numLins = 8;
const firstLin = 1;
const firstCol = 1;

const codeforcesColor = 'mediumBlue';
const githubColor = 'forestGreen';
const inactiveColor = 'dimgray';

let currentSelectedYear = 0;

window.onload = function () {
    addYearOptions();
    addJsonInfoToCalendar();
    addClickListener();
    addLastTimeUpdated();
}

function addYearOptions() {
    document.getElementById('year-filter-container').innerHTML +=
        `<div class="filter sm-display-block">
            <input id="year0" type="checkbox" checked onclick="addJsonInfoToCalendar(0)">
            <label for="year0">Now</label>
        </div>`;

    const yearNow = new Date().getFullYear();
    const yearDiff = yearNow - 2022;
    for (let i = 1; i <= yearDiff; i++) {
        const id = 'year' + i;
        document.getElementById('year-filter-container').innerHTML +=
            `<div class="filter sm-display-block">
                <input id="${id}" type="checkbox" onclick="addJsonInfoToCalendar(${i})">
                <label for="${id}">${i} year(s) ago</label>
            </div>`;
    }
}

function addJsonInfoToCalendar(yearDiff) {
    if (yearDiff === undefined) yearDiff = currentSelectedYear;
    currentSelectedYear = yearDiff;
    updateYearCheckboxes(yearDiff);
    
    let table = document.getElementById("calendar");
    resetMonthsNames(table);

    let currDate = new Date();
    currDate.setTime(currDate.getTime() - (yearDiff * msInADay * 365));
    let dayOfWeek = currDate.getDay();

    hideExtraDaySquares(table, dayOfWeek);
    highlightRightMostSquare(table, table.rows[firstLin+dayOfWeek].cells[numCols-1]);
    setToolTips(table, currDate, dayOfWeek);
}

function setToolTips(table, currDate, dayOfWeek) {
    for (let i = firstLin+dayOfWeek; i >= firstLin; i--) {
        setDayActivity(table.rows[i].cells[numCols-1], currDate);
        writeMonthName(currDate, table.rows[0].cells[numCols-1]);
        currDate.setTime(currDate.getTime() - msInADay);
    }

    for (let j = numCols-2; j >= firstCol; j--) {
        for (let i = numLins-1; i >= firstLin; i--) {
            setDayActivity(table.rows[i].cells[j], currDate);
            writeMonthName(currDate, table.rows[0].cells[j]);

            currDate.setTime(currDate.getTime() - msInADay);
        }
    }
}

function highlightRightMostSquare(table, cell) {
    for (let i = firstLin; i < numLins; i++) {
        table.rows[i].cells[numCols-1].style.borderWidth = '0';
    }
    cell.style.border = 'solid';
    cell.style.borderColor = 'yellow';
    cell.style.borderWidth = '1px';
}

function updateYearCheckboxes(selectedYear) {
    const yearNow = new Date().getFullYear();
    const yearDiff = yearNow - 2022;
    for (let i = 0; i <= yearDiff; i++) {
        document.getElementById('year' + i).checked = false;
    }
    document.getElementById('year' + selectedYear).checked = true;
}

function writeMonthName(date, cell) {
    if (date.getDate() != 1) return;

    cell.innerHTML = date.toLocaleString('en-US', { month: 'long' }).substring(0, 3);
    cell.style.visibility = 'visible';
    cell.style.background = 'rgba(0,0,0,0)';
}

function hideExtraDaySquares(table, dayOfWeek) {
    for (let i = firstLin; i < numLins; i++) {
        table.rows[i].cells[firstLin].style.visibility = 'visible';
        table.rows[i].cells[numCols-1].style.visibility = 'visible';
    }
    for (let i = firstLin; i < dayOfWeek+firstLin; i++) { table.rows[i].cells[firstLin].style.visibility = 'hidden'; }
    for (let i = firstLin+dayOfWeek+1; i < numLins; i++) { table.rows[i].cells[numCols-1].style.visibility = 'hidden'; }
}

function resetMonthsNames(table) {
    for (let i=0; i < numCols; i++) {
        table.rows[0].cells[i].innerHTML = '';
    }
}

function setDayActivity(cell, date) {
    let dateStr = formatter.format(date);
    
    if (!json.hasOwnProperty(dateStr)) {
        cell.getElementsByTagName('span')[0].innerHTML = 'no activity on ' + dateStr;
        cell.style.backgroundColor = inactiveColor;
        return;
    }
    const cf = json[dateStr]["cf"];
    const gh = json[dateStr]["gh"];
    let cf_checked = document.getElementById('cf-checkbox').checked;
    let gh_checked = document.getElementById('gh-checkbox').checked;

    if (cf_checked && cf >= gh) { cell.style.backgroundColor = codeforcesColor; }
    else if (gh_checked && gh > 0) { cell.style.backgroundColor = githubColor; }
    else { cell.style.backgroundColor = inactiveColor; }

    let activities = 0;
    if (cf_checked) activities += cf;
    if (gh_checked) activities += gh;
    cell.getElementsByTagName('span')[0].innerHTML = activities + ' activities on ' + dateStr;
}

function addClickListener() {
    const tbody = document.querySelector('#calendar tbody');
    tbody.addEventListener('click', function (e) {
        const cell = e.target.closest('td');
        if (!cell) return;
        
        let dateStr = cell.getElementsByTagName('span')[0].innerHTML.split(' ').pop();
        let title = document.getElementById('detail-title');
        title.innerHTML = 'Showing details for ' + dateStr;

        let cf = 0;
        let gh = 0;
        if (json.hasOwnProperty(dateStr)) {
            cf = json[dateStr]["cf"];
            gh = json[dateStr]["gh"];
        }
        document.getElementById('codeforces-detail').innerHTML = "activity in codeforces: " + cf;
        document.getElementById('github-detail').innerHTML = "activity in github: " + gh;
        document.getElementById('day-details').className = 'highlight';
        setTimeout(() => {
            document.getElementById('day-details').className = '';
        }, 300);
    });
}

function addLastTimeUpdated() {
    document.getElementById('last-update').innerHTML = `
    <p>Last time updated: ${last_update}</p>
    `
}